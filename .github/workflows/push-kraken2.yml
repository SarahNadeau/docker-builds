# This caller workflow tests, builds, and pushes the image to Docker Hub.
# It also tests that a Singularity container can be run from the Docker image.
# TODO: change called workflow and dockerhub references to StaPH-B if accepted in PR

name: Push Kraken 2 image

on: workflow_dispatch

jobs:

  build-to-test:
    uses: SarahNadeau/docker-builds/.github/workflows/build-to-test.yml@sarah-dev  # TODO: change
    with:
      path_to_context: "."
      dockerfile_name: "./kraken2/2.0.8-beta/Dockerfile"
      cache: "kraken"

  build-and-push:
    needs: build-to-test  # this jobs needs to run serially, after testing succeeds
    uses: SarahNadeau/docker-builds/.github/workflows/build-and-push.yml@sarah-dev  # TODO: change
    with:
      path_to_context: "."
      dockerfile_name: "./kraken2/2.0.8-beta/Dockerfile"
      cache: "kraken"
      container_name: "kraken2"
      tag: 2.0.8-beta
    secrets:
      docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}  # TODO: change
      docker_hub_access_token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}  # TODO: change

  run-singularity:
    needs: build-and-push  # test singularity run on newly pushed Docker image
    uses: SarahNadeau/docker-builds/.github/workflows/run-singularity.yml@sarah-dev  # TODO: change
    with:
      dockerhub_image: "snads/kraken2:2.0.8-beta"
