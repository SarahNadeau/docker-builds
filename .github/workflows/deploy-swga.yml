name: Deploy SWGA image

on: workflow_dispatch

jobs:

  # This job calls a workflow to build the image to the 'test' stage
  build-to-test:
    uses: ./.github/workflows/build-to-test.yml
    with:
      path_to_context: "./swga/0.4.4/"
      dockerfile_name: "Dockerfile"
      cache: "swga"

  # This job calls a workflow to build the image to the 'app' stage and pushes the image to Docker Hub
  build-to-deploy:
    needs: build-to-test
    uses: ./.github/workflows/build-to-deploy.yml
    with:
      path_to_context: "./swga/0.4.4/"
      dockerfile_name: "Dockerfile"
      cache: "swga"
      container_name: "swga"
      tag: "0.4.4"
    secrets:
      docker_username: ${{ secrets.DOCKER_HUB_USERNAME }}
      docker_access_token: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

  # This job calls a workflow to pull the image from Docker Hub and test that it can be run as a Singularity container
  run-singularity:
    needs: build-to-deploy
    uses: ./.github/workflows/run-singularity.yml
    with:
      repository_name: "snads"  # TODO: change
      image_name: "swga:0.4.4"
